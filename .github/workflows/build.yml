name: Build cross-platform executables

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build with PyInstaller (Windows)
        run: |
          pyinstaller --onefile --windowed --name png_bmp_converter converter_gui.py
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: png_bmp_converter-windows
          path: dist/png_bmp_converter.exe

  build-macos:
    name: Build macOS binary
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Rosetta (for x86_64 build)
        run: |
          sudo softwareupdate --install-rosetta --agree-to-license || true

      - name: Build ARM64 .app (native)
        run: |
          python3 -m venv build/venv_arm
          . build/venv_arm/bin/activate
          python3 -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller
          # Use venv's pyinstaller to produce ARM64 app in isolated dist/work dirs
          build/venv_arm/bin/pyinstaller --windowed --name png_bmp_converter --clean -y \
            --distpath dist/arm --workpath build/arm --specpath build/arm_spec \
            converter_gui.py
          mv dist/arm/png_bmp_converter.app dist/png_bmp_converter-arm.app

      - name: Build x86_64 .app (Rosetta)
        run: |
          # Create an x86_64 venv using Rosetta and install x86_64 wheels into it
          arch -x86_64 python3 -m venv build/venv_x86
          # Use the venv's pip (run under Rosetta) to install correct-arch wheels
          arch -x86_64 build/venv_x86/bin/python -m pip install --upgrade pip
          arch -x86_64 build/venv_x86/bin/pip install -r requirements.txt pyinstaller
          # Use the venv's pyinstaller (Rosetta/x86) to produce x86_64 app in isolated dirs
          arch -x86_64 build/venv_x86/bin/pyinstaller --windowed --name png_bmp_converter --clean -y \
            --distpath dist/x86 --workpath build/x86 --specpath build/x86_spec \
            converter_gui.py
          mv dist/x86/png_bmp_converter.app dist/png_bmp_converter-x86.app

      - name: Create universal binary (.app)
        run: |
          set -e
          ARM_APP=dist/png_bmp_converter-arm.app
          X86_APP=dist/png_bmp_converter-x86.app
          U_APP=dist/png_bmp_converter.app
          # Copy ARM app as base
          cp -R "$ARM_APP" "$U_APP"
          ARM_BIN="$ARM_APP/Contents/MacOS/png_bmp_converter"
          X86_BIN="$X86_APP/Contents/MacOS/png_bmp_converter"
          U_BIN="$U_APP/Contents/MacOS/png_bmp_converter"
          # Create universal binary combining both architectures
          lipo -create -output "$U_BIN" "$ARM_BIN" "$X86_BIN"
          chmod +x "$U_BIN"

      - name: Upload macOS universal artifact
        uses: actions/upload-artifact@v4
        with:
          name: png_bmp_converter-macos-universal
          path: dist/png_bmp_converter.app
